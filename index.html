<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Participantes - Sistema Avanzado</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #3b82f6;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .metric-card {
            @apply glass-card p-6 rounded-2xl transform transition-all duration-500 hover:scale-105 hover:shadow-2xl cursor-pointer;
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-left: 4px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .metric-card:hover::before {
            transform: scaleX(1);
        }

        .primary-card { border-left-color: #667eea; }
        .success-card { border-left-color: var(--success-color); }
        .warning-card { border-left-color: var(--warning-color); }
        .error-card { border-left-color: var(--error-color); }
        .info-card { border-left-color: var(--info-color); }

        .metric-title {
            @apply text-sm font-semibold text-gray-600 uppercase tracking-wider mb-2;
        }

        .metric-value {
            @apply text-3xl font-bold mb-1;
        }

        .main-metric-value {
            @apply text-6xl font-black bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
        }

        .status-badge {
            @apply inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold transition-all duration-300;
        }

        .status-active {
            @apply bg-green-100 text-green-800 border border-green-200;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .status-inactive {
            @apply bg-yellow-100 text-yellow-800 border border-yellow-200;
            animation: pulse 2s infinite;
        }

        .status-error {
            @apply bg-red-100 text-red-800 border border-red-200;
        }

        .status-server-error {
            @apply bg-purple-100 text-purple-800 border border-purple-200;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-slide-in {
            animation: slideInUp 0.8s ease-out forwards;
        }

        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .loading-spinner {
            @apply inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .data-table {
            @apply w-full divide-y divide-gray-200 rounded-xl overflow-hidden shadow-lg;
            background: rgba(255, 255, 255, 0.95);
        }

        .table-header {
            @apply px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider bg-gradient-to-r from-gray-50 to-gray-100;
        }

        .table-row {
            @apply hover:bg-blue-50 transition-all duration-200 cursor-pointer;
        }

        .table-cell {
            @apply px-6 py-4 whitespace-nowrap text-sm text-gray-800;
        }

        .icon-badge {
            @apply w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold;
        }

        .section-header {
            @apply text-2xl font-bold text-gray-800 mb-6 flex items-center;
        }

        .section-header::before {
            content: '';
            @apply w-1 h-8 bg-gradient-to-b from-blue-500 to-purple-600 rounded-full mr-3;
        }

        .progress-bar {
            @apply w-full bg-gray-200 rounded-full h-2 overflow-hidden;
        }

        .progress-fill {
            @apply h-full bg-gradient-to-r from-blue-500 to-purple-600 transition-all duration-1000 ease-out;
        }

        .floating-btn {
            @apply fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-full shadow-2xl flex items-center justify-center text-xl transition-all duration-300 hover:scale-110 z-50;
        }

        .notification {
            @apply fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            @apply bg-green-100 text-green-800 border border-green-200;
        }

        .notification.error {
            @apply bg-red-100 text-red-800 border border-red-200;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-100 to-purple-100">
    <!-- Notification Container -->
    <div id="notifications"></div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-700 text-white shadow-2xl">
        <div class="container mx-auto px-6 py-8">
            <div class="flex flex-col lg:flex-row justify-between items-center space-y-4 lg:space-y-0">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-chart-bar text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-4xl font-black tracking-tight">Dashboard Participantes</h1>
                        <p class="text-blue-200 text-sm font-medium">Sistema de Gestión Avanzado</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div id="lastUpdate" class="text-blue-200 text-sm"></div>
                    <div id="connectionStatus" class="status-badge status-inactive">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        Inicializando...
                    </div>
                    <button id="refreshBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-6 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 flex items-center space-x-2">
                        <i id="refreshIcon" class="fas fa-sync-alt"></i>
                        <span>Actualizar</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-10 space-y-10">
        
        <!-- Resumen General -->
        <section class="animate-slide-in" style="animation-delay: 0.1s;">
            <h2 class="section-header">
                <i class="fas fa-users text-blue-600 mr-3"></i>
                Resumen General
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Total Participantes -->
                <div class="metric-card primary-card lg:col-span-3 text-center">
                    <div class="metric-title">Total de Participantes</div>
                    <div id="totalParticipants" class="main-metric-value">0</div>
                    <div class="progress-bar mt-4">
                        <div id="totalProgress" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Niños -->
                <div class="metric-card info-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="metric-title">Niños</div>
                            <div id="totalBoys" class="metric-value text-blue-600">0</div>
                        </div>
                        <div class="icon-badge bg-blue-500">
                            <i class="fas fa-child"></i>
                        </div>
                    </div>
                    <div id="boysProgress" class="progress-bar mt-3">
                        <div class="progress-fill bg-blue-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Niñas -->
                <div class="metric-card success-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="metric-title">Niñas</div>
                            <div id="totalGirls" class="metric-value text-pink-600">0</div>
                        </div>
                        <div class="icon-badge bg-pink-500">
                            <i class="fas fa-female"></i>
                        </div>
                    </div>
                    <div id="girlsProgress" class="progress-bar mt-3">
                        <div class="progress-fill bg-pink-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- No Nacidos -->
                <div class="metric-card warning-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="metric-title">Por Nacer</div>
                            <div id="notBorn" class="metric-value text-yellow-600">0</div>
                        </div>
                        <div class="icon-badge bg-yellow-500">
                            <i class="fas fa-baby"></i>
                        </div>
                    </div>
                    <div id="notBornProgress" class="progress-bar mt-3">
                        <div class="progress-fill bg-yellow-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Nivel Educativo -->
        <section class="animate-slide-in" style="animation-delay: 0.3s;">
            <h2 class="section-header">
                <i class="fas fa-graduation-cap text-green-600 mr-3"></i>
                Nivel Educativo
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                <!-- No Estudiando -->
                <div class="metric-card error-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="metric-title">Sin Estudios</div>
                            <div id="notStudying" class="metric-value text-red-600">0</div>
                        </div>
                        <div class="icon-badge bg-red-500">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                </div>

                <!-- Primaria -->
                <div class="metric-card info-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="metric-title">Primaria</div>
                            <div id="inPrimary" class="metric-value text-blue-600">0</div>
                        </div>
                        <div class="icon-badge bg-blue-500">
                            <i class="fas fa-book"></i>
                        </div>
                    </div>
                </div>

                <!-- Bachillerato -->
                <div class="metric-card success-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="metric-title">Bachillerato</div>
                            <div id="inHighSchool" class="metric-value text-green-600">0</div>
                        </div>
                        <div class="icon-badge bg-green-500">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                    </div>
                </div>

                <!-- Técnico -->
                <div class="metric-card warning-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="metric-title">Técnico</div>
                            <div id="technical" class="metric-value text-orange-600">0</div>
                        </div>
                        <div class="icon-badge bg-orange-500">
                            <i class="fas fa-tools"></i>
                        </div>
                    </div>
                </div>

                <!-- Universidad -->
                <div class="metric-card primary-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="metric-title">Universidad</div>
                            <div id="university" class="metric-value text-purple-600">0</div>
                        </div>
                        <div class="icon-badge bg-purple-500">
                            <i class="fas fa-university"></i>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Grupos por Edad -->
        <section class="animate-slide-in" style="animation-delay: 0.5s;">
            <h2 class="section-header">
                <i class="fas fa-layer-group text-purple-600 mr-3"></i>
                Grupos por Edad
            </h2>
            <div id="ageGroupCards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
        </section>

        <!-- Tutoras -->
        <section class="animate-slide-in" style="animation-delay: 0.7s;">
            <h2 class="section-header">
                <i class="fas fa-chalkboard-teacher text-indigo-600 mr-3"></i>
                Distribución por Tutoras
            </h2>
            <div id="tutorCards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </section>

        <!-- Actividades de la Semana -->
        <section class="animate-slide-in" style="animation-delay: 0.9s;">
            <h2 class="section-header">
                <i class="fas fa-calendar-week text-teal-600 mr-3"></i>
                Actividades de la Semana
            </h2>
            
            <div class="glass-card rounded-2xl overflow-hidden">
                <div id="activitiesContent">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="table-header">
                                    <i class="fas fa-calendar mr-2"></i>Fecha
                                </th>
                                <th class="table-header">
                                    <i class="fas fa-star mr-2"></i>Actividad
                                </th>
                                <th class="table-header">
                                    <i class="fas fa-info-circle mr-2"></i>Descripción
                                </th>
                            </tr>
                        </thead>
                        <tbody id="activitiesTableBody"></tbody>
                    </table>
                    <div id="noActivitiesMessage" class="hidden text-center py-12">
                        <div class="text-6xl mb-4">📅</div>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay actividades programadas</h3>
                        <p class="text-gray-500">¡Tiempo perfecto para planificar nuevas aventuras!</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Floating Action Button -->
    <button id="floatingRefresh" class="floating-btn">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script>
        class ParticipantsDashboard {
            constructor() {
                this.GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz4weug7FGWiujFzaNMShwTg7Y-gNi9EEDL_ow2Vmw_lm8rAUdIIqWGbkQHLtPmsdMV/exec";
                this.isLoading = false;
                this.lastUpdate = null;
                this.retryCount = 0;
                this.maxRetries = 3;
                
                this.initializeEventListeners();
                this.loadData();
                this.startAutoRefresh();
            }

            initializeEventListeners() {
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadData(true));
                document.getElementById('floatingRefresh').addEventListener('click', () => this.loadData(true));
            }

            startAutoRefresh() {
                // Auto-refresh cada 5 minutos
                setInterval(() => {
                    if (!this.isLoading) {
                        this.loadData();
                    }
                }, 300000);
            }

            setConnectionStatus(status, message = '') {
                const statusElement = document.getElementById('connectionStatus');
                const iconClasses = {
                    active: 'fas fa-check-circle',
                    inactive: 'fas fa-spinner fa-spin',
                    error: 'fas fa-exclamation-triangle',
                    server_error: 'fas fa-server'
                };

                const statusMessages = {
                    active: 'Conectado',
                    inactive: 'Cargando...',
                    error: 'Error de Conexión',
                    server_error: 'Error del Servidor (404)'
                };

                statusElement.className = `status-badge status-${status === 'server_error' ? 'server-error' : status}`;
                statusElement.innerHTML = `
                    <i class="${iconClasses[status]} mr-2"></i>
                    ${message || statusMessages[status]}
                `;
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                        <span>${message}</span>
                    </div>
                `;

                document.getElementById('notifications').appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 100);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 4000);
            }

            updateLastUpdate() {
                this.lastUpdate = new Date();
                document.getElementById('lastUpdate').textContent = 
                    `Última actualización: ${this.lastUpdate.toLocaleTimeString()}`;
            }

            setLoadingState(loading) {
                this.isLoading = loading;
                const refreshBtn = document.getElementById('refreshBtn');
                const refreshIcon = document.getElementById('refreshIcon');
                const floatingBtn = document.getElementById('floatingRefresh');

                if (loading) {
                    refreshIcon.className = 'fas fa-spinner fa-spin';
                    refreshBtn.disabled = true;
                    floatingBtn.style.opacity = '0.6';
                    this.setConnectionStatus('inactive');
                } else {
                    refreshIcon.className = 'fas fa-sync-alt';
                    refreshBtn.disabled = false;
                    floatingBtn.style.opacity = '1';
                }
            }

            async loadData(manual = false) {
                if (this.isLoading) return;

                this.setLoadingState(true);

                try {
                    const [participantsResponse, activitiesResponse] = await Promise.all([
                        fetch(`${this.GOOGLE_APPS_SCRIPT_URL}?sheet=Participantes`),
                        fetch(`${this.GOOGLE_APPS_SCRIPT_URL}?sheet=Actividades`)
                    ]);

                    // Manejo específico de errores
                    if (participantsResponse.status === 404 || activitiesResponse.status === 404) {
                        throw new Error('SERVER_404');
                    }

                    if (!participantsResponse.ok || !activitiesResponse.ok) {
                        throw new Error('FETCH_ERROR');
                    }

                    const participants = await participantsResponse.json();
                    const activities = await activitiesResponse.json();

                    if (participants.error || activities.error) {
                        throw new Error('DATA_ERROR');
                    }

                    this.processData(participants, activities);
                    this.setConnectionStatus('active');
                    this.updateLastUpdate();
                    this.retryCount = 0;

                    if (manual) {
                        this.showNotification('Datos actualizados correctamente', 'success');
                    }

                } catch (error) {
                    this.handleError(error, manual);
                } finally {
                    this.setLoadingState(false);
                }
            }

            handleError(error, manual) {
                this.retryCount++;

                if (error.message === 'SERVER_404') {
                    this.setConnectionStatus('server_error');
                    if (manual) {
                        this.showNotification('Error 404: Servidor no encontrado', 'error');
                    }
                } else if (!navigator.onLine) {
                    this.setConnectionStatus('error', 'Sin conexión a internet');
                    if (manual) {
                        this.showNotification('Sin conexión a internet', 'error');
                    }
                } else {
                    this.setConnectionStatus('error');
                    if (manual) {
                        this.showNotification('Error al cargar los datos', 'error');
                    }
                }

                // Auto-retry logic
                if (this.retryCount < this.maxRetries && !manual) {
                    setTimeout(() => this.loadData(), 5000 * this.retryCount);
                }
            }

            processData(participants, activities) {
                this.processParticipants(participants);
                this.processActivities(activities);
                this.animateCounters();
            }

            processParticipants(participants) {
                const stats = this.calculateStats(participants);
                this.updateGeneralStats(stats);
                this.updateEducationStats(stats);
                this.updateAgeGroups(stats.ageGroups);
                this.updateTutorCards(stats.tutorCounts);
            }

            calculateStats(participants) {
                const stats = {
                    total: participants.length,
                    boys: 0,
                    girls: 0,
                    notBorn: 0,
                    notStudying: 0,
                    inPrimary: 0,
                    inHighSchool: 0,
                    technical: 0,
                    university: 0,
                    ageGroups: {
                        'SUPERVIVENCIA (0-1)': 0,
                        'CAMINADORES (1-2)': 0,
                        'EXPLORADORES (3-5)': 0,
                        'SEMILLAS (6-8)': 0,
                        'VENCEDORES (9-11)': 0,
                        'VISIONARIOS (12-14)': 0,
                        'GENERACIÓN EX. (15-18)': 0,
                        'JÓVENES (19+)': 0
                    },
                    tutorCounts: {}
                };

                participants.forEach(participant => {
                    this.processSex(participant, stats);
                    this.processEducation(participant, stats);
                    this.processAge(participant, stats);
                    this.processTutor(participant, stats);
                });

                return stats;
            }

            processSex(participant, stats) {
                const sex = participant.SEXO ? participant.SEXO.toUpperCase().trim() : '';
                
                if (sex === '-' || sex === '' || !participant['FECHA NACIMIENTO']) {
                    stats.notBorn++;
                } else if (sex === 'FEMENINO' || sex === 'F') {
                    stats.girls++;
                } else if (sex === 'MASCULINO' || sex === 'M') {
                    stats.boys++;
                }
            }

            processEducation(participant, stats) {
                const grado = (participant['GRADO ESCOLAR'] || '').toUpperCase().trim();
                const tecnico = (participant.TECNICO || '').toUpperCase().trim();

                // Prioridad 1: Universidad (siempre gana sobre técnico)
                if (grado.includes('UNIVERSIDAD')) {
                    stats.university++;
                    return;
                }

                // Prioridad 2: Técnico (solo si no hay universidad)
                if (tecnico && tecnico !== '-' && tecnico !== '') {
                    stats.technical++;
                    return;
                }

                // Prioridad 3: Bachillerato/Secundaria
                if (grado.includes('BACHILLER') || grado.includes('SECUNDARIA')) {
                    stats.inHighSchool++;
                    return;
                }

                // Prioridad 4: Primaria
                if (grado.includes('PRIMARIA') || grado.includes('PREPARATORIA')) {
                    stats.inPrimary++;
                    return;
                }

                // Si no está en ninguna categoría o está marcado como "No Inscrito"
                if (grado.includes('NO INSCRITO') || grado === '' || grado === '-') {
                    stats.notStudying++;
                }
            }

            processAge(participant, stats) {
                if (!participant['FECHA NACIMIENTO']) return;

                const birthDate = new Date(participant['FECHA NACIMIENTO']);
                if (isNaN(birthDate)) return;

                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }

                if (age >= 0 && age <= 1) stats.ageGroups['SUPERVIVENCIA (0-1)']++;
                else if (age > 1 && age <= 2) stats.ageGroups['CAMINADORES (1-2)']++;
                else if (age > 2 && age <= 5) stats.ageGroups['EXPLORADORES (3-5)']++;
                else if (age > 5 && age <= 8) stats.ageGroups['SEMILLAS (6-8)']++;
                else if (age > 8 && age <= 11) stats.ageGroups['VENCEDORES (9-11)']++;
                else if (age > 11 && age <= 14) stats.ageGroups['VISIONARIOS (12-14)']++;
                else if (age > 14 && age <= 18) stats.ageGroups['GENERACIÓN EX. (15-18)']++;
                else if (age >= 19) stats.ageGroups['JÓVENES (19+)']++;
            }

            processTutor(participant, stats) {
                const tutor = participant.TUTORA ? participant.TUTORA.trim() : 'Sin Asignar';
                stats.tutorCounts[tutor] = (stats.tutorCounts[tutor] || 0) + 1;
            }

            updateGeneralStats(stats) {
                document.getElementById('totalParticipants').textContent = stats.total;
                document.getElementById('totalBoys').textContent = stats.boys;
                document.getElementById('totalGirls').textContent = stats.girls;
                document.getElementById('notBorn').textContent = stats.notBorn;

                // Update progress bars
                if (stats.total > 0) {
                    const boysPercent = (stats.boys / stats.total) * 100;
                    const girlsPercent = (stats.girls / stats.total) * 100;
                    const notBornPercent = (stats.notBorn / stats.total) * 100;

                    setTimeout(() => {
                        document.querySelector('#boysProgress .progress-fill').style.width = `${boysPercent}%`;
                        document.querySelector('#girlsProgress .progress-fill').style.width = `${girlsPercent}%`;
                        document.querySelector('#notBornProgress .progress-fill').style.width = `${notBornPercent}%`;
                        document.querySelector('#totalProgress').style.width = '100%';
                    }, 500);
                }
            }

            updateEducationStats(stats) {
                document.getElementById('notStudying').textContent = stats.notStudying;
                document.getElementById('inPrimary').textContent = stats.inPrimary;
                document.getElementById('inHighSchool').textContent = stats.inHighSchool;
                document.getElementById('technical').textContent = stats.technical;
                document.getElementById('university').textContent = stats.university;
            }

            updateAgeGroups(ageGroups) {
                const container = document.getElementById('ageGroupCards');
                container.innerHTML = '';

                const colors = [
                    'from-red-400 to-red-600',
                    'from-orange-400 to-orange-600',
                    'from-yellow-400 to-yellow-600',
                    'from-green-400 to-green-600',
                    'from-blue-400 to-blue-600',
                    'from-indigo-400 to-indigo-600',
                    'from-purple-400 to-purple-600',
                    'from-pink-400 to-pink-600'
                ];

                Object.entries(ageGroups).forEach(([groupName, count], index) => {
                    const card = document.createElement('div');
                    card.className = 'metric-card primary-card animate-fade-in';
                    card.style.animationDelay = `${index * 0.1}s`;
                    
                    card.innerHTML = `
                        <div class="text-center">
                            <div class="w-12 h-12 mx-auto mb-3 bg-gradient-to-br ${colors[index]} rounded-full flex items-center justify-center text-white font-bold text-lg">
                                ${count}
                            </div>
                            <h3 class="metric-title text-center">${groupName}</h3>
                            <div class="text-lg font-semibold text-gray-700">${count} participantes</div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            }

            updateTutorCards(tutorCounts) {
                const container = document.getElementById('tutorCards');
                container.innerHTML = '';

                const colors = [
                    'from-teal-400 to-teal-600',
                    'from-cyan-400 to-cyan-600',
                    'from-sky-400 to-sky-600',
                    'from-blue-400 to-blue-600',
                    'from-indigo-400 to-indigo-600',
                    'from-purple-400 to-purple-600',
                    'from-fuchsia-400 to-fuchsia-600',
                    'from-pink-400 to-pink-600',
                    'from-rose-400 to-rose-600',
                    'from-red-400 to-red-600'
                ];

                Object.entries(tutorCounts).forEach(([tutorName, count], index) => {
                    const card = document.createElement('div');
                    card.className = 'metric-card success-card animate-fade-in cursor-pointer transform transition-all duration-300 hover:scale-105';
                    card.style.animationDelay = `${index * 0.1}s`;
                    
                    const colorIndex = index % colors.length;
                    
                    card.innerHTML = `
                        <div class="text-center">
                            <div class="w-14 h-14 mx-auto mb-3 bg-gradient-to-br ${colors[colorIndex]} rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-1 text-sm">${tutorName}</h3>
                            <div class="text-2xl font-bold text-teal-600">${count}</div>
                            <div class="text-xs text-gray-500">participantes</div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            }

            processActivities(activities) {
                const tableBody = document.getElementById('activitiesTableBody');
                const noActivitiesMsg = document.getElementById('noActivitiesMessage');
                
                tableBody.innerHTML = '';

                const currentWeek = this.getCurrentWeekRange();
                let activitiesFound = false;

                activities.forEach(activity => {
                    const activityDate = this.parseActivityDate(activity.Fecha);
                    
                    if (activityDate && activityDate >= currentWeek.start && activityDate <= currentWeek.end) {
                        const row = document.createElement('tr');
                        row.className = 'table-row';
                        
                        row.innerHTML = `
                            <td class="table-cell">
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                    <span class="font-semibold">${this.formatDate(activityDate)}</span>
                                </div>
                            </td>
                            <td class="table-cell">
                                <div class="font-medium text-gray-900">${activity.Actividad || 'Sin título'}</div>
                            </td>
                            <td class="table-cell">
                                <div class="text-gray-600">${activity.Descripción || 'Sin descripción'}</div>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                        activitiesFound = true;
                    }
                });

                if (activitiesFound) {
                    noActivitiesMsg.classList.add('hidden');
                } else {
                    noActivitiesMsg.classList.remove('hidden');
                }
            }

            getCurrentWeekRange() {
                const today = new Date();
                const dayOfWeek = today.getDay();
                const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                
                const start = new Date(today.getFullYear(), today.getMonth(), diff);
                start.setHours(0, 0, 0, 0);
                
                const end = new Date(start);
                end.setDate(start.getDate() + 6);
                end.setHours(23, 59, 59, 999);
                
                return { start, end };
            }

            parseActivityDate(dateStr) {
                if (!dateStr) return null;

                let date;
                
                if (dateStr.includes('-') && dateStr.split('-')[0].length === 4) {
                    date = new Date(dateStr);
                } else if (dateStr.includes('/')) {
                    const parts = dateStr.split('/').map(Number);
                    if (parts.length === 3) {
                        const [p1, p2, p3] = parts;
                        if (p1 > 12) {
                            date = new Date(p3, p2 - 1, p1);
                        } else {
                            date = new Date(p3, p1 - 1, p2);
                        }
                    }
                }
                
                return date && !isNaN(date) ? date : null;
            }

            formatDate(date) {
                return date.toLocaleDateString('es-ES', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short'
                });
            }

            animateCounters() {
                const counters = document.querySelectorAll('.metric-value, .main-metric-value');
                
                counters.forEach(counter => {
                    const target = parseInt(counter.textContent);
                    if (isNaN(target)) return;
                    
                    let current = 0;
                    const increment = target / 30;
                    const duration = 1000;
                    const stepTime = duration / 30;
                    
                    const timer = setInterval(() => {
                        current += increment;
                        if (current >= target) {
                            counter.textContent = target;
                            clearInterval(timer);
                        } else {
                            counter.textContent = Math.floor(current);
                        }
                    }, stepTime);
                });
            }
        }

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new ParticipantsDashboard();
        });

        // Service Worker para PWA (opcional)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {
                // Service worker no disponible
            });
        }
    </script>
</body>
</html>
